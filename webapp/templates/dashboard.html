<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Farm System - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-icon {
            font-size: 2em;
            margin-right: 15px;
        }
        
        .card-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
        }
        
        .status-label {
            font-weight: 500;
            color: #666;
        }
        
        .status-value {
            font-weight: bold;
            color: #333;
        }
        
        .status-connected {
            color: #28a745;
        }
        
        .status-disconnected {
            color: #dc3545;
        }
        
        .status-unknown {
            color: #ffc107;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            min-width: 120px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            opacity: 0.8;
        }
        
        .last-update {
            font-size: 0.9em;
            color: #999;
            margin-top: 10px;
        }
        
        .signal-bar {
            display: inline-block;
            width: 100px;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-left: 10px;
        }
        
        .signal-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ffa502, #2ed573);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Proxy Farm System</h1>
            <p>Dashboard qu·∫£n l√Ω DCOM v√† 3Proxy - Phase 1</p>
        </div>

        <div id="alerts"></div>

        <div class="cards-grid">
            <!-- DCOM Status Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üì°</div>
                    <div class="card-title">DCOM Status</div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Tr·∫°ng th√°i:</span>
                    <span class="status-value" id="dcom-status">ƒêang t·∫£i...</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Signal:</span>
                    <span class="status-value" id="dcom-signal">N/A</span>
                    <div class="signal-bar">
                        <div class="signal-fill" id="signal-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Public IP:</span>
                    <span class="status-value" id="dcom-ip">N/A</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">M·∫°ng:</span>
                    <span class="status-value" id="dcom-network">N/A</span>
                </div>
                
                <div class="actions">
                    <button class="btn btn-warning" onclick="restartDCOM()">üîÑ Restart Connection</button>
                    <button class="btn" onclick="location.href='/dcom-management'">üì° DCOM Management</button>
                    <button class="btn" onclick="refreshStatus()">üîÉ Refresh</button>
                </div>
                
                <div class="last-update" id="dcom-last-update"></div>
            </div>

            <!-- 3Proxy Status Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üîó</div>
                    <div class="card-title">3Proxy Status</div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Tr·∫°ng th√°i:</span>
                    <span class="status-value" id="proxy-status">ƒêang t·∫£i...</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Process ID:</span>
                    <span class="status-value" id="proxy-pid">N/A</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Port:</span>
                    <span class="status-value">8080 (HTTP)</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Type:</span>
                    <span class="status-value">HTTP/HTTPS Proxy</span>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="startProxy()">‚ñ∂Ô∏è Start</button>
                    <button class="btn btn-danger" onclick="stopProxy()">‚èπÔ∏è Stop</button>
                    <button class="btn" onclick="refreshStatus()">üîÉ Refresh</button>
                </div>
                
                <div class="last-update" id="proxy-last-update"></div>
            </div>

            <!-- APN Info Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üì±</div>
                    <div class="card-title">APN Configuration</div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Profile Name:</span>
                    <span class="status-value" id="apn-name">ƒêang t·∫£i...</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">APN:</span>
                    <span class="status-value" id="apn-value">N/A</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Username:</span>
                    <span class="status-value" id="apn-username">N/A</span>
                </div>
                
                <div class="actions">
                    <button class="btn" onclick="showAPNProfiles()">üìã View Profiles</button>
                    <button class="btn btn-warning" onclick="openAPNManager()">‚öôÔ∏è Manage APN</button>
                </div>
            </div>

            <!-- User Management Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üë•</div>
                    <div class="card-title">User Management</div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Total Users:</span>
                    <span class="status-value" id="user-count">Loading...</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Active Connections:</span>
                    <span class="status-value" id="active-connections">0</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Online Users:</span>
                    <span class="status-value" id="online-users">0</span>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="location.href='/users'">üë• User Management</button>
                    <button class="btn" onclick="generateRandomUser()">üé≤ Random User</button>
                    <button class="btn btn-warning" onclick="location.href='/direct-connection'">‚ö° Direct Connection</button>
                </div>
            </div>

            <!-- Proxy Testing Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üß™</div>
                    <div class="card-title">Proxy Testing</div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Test Port:</span>
                    <select id="test-port" class="status-value" style="border: 1px solid #ddd; padding: 5px; border-radius: 5px;">
                        <option value="3330">3330 (Multi-Protocol)</option>
                        <option value="3331">3331 (HTTP)</option>
                        <option value="3335">3335 (SOCKS5)</option>
                        <option value="3337">3337 (SOCKS4)</option>
                        <option value="3338">3338 (HTTP No-Auth)</option>
                    </select>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Username:</span>
                    <input type="text" id="test-username" placeholder="admin" style="border: 1px solid #ddd; padding: 5px; border-radius: 5px; width: 120px;">
                </div>
                
                <div class="status-item">
                    <span class="status-label">Password:</span>
                    <input type="password" id="test-password" placeholder="password" style="border: 1px solid #ddd; padding: 5px; border-radius: 5px; width: 120px;">
                </div>
                
                <div class="actions">
                    <button class="btn btn-warning" onclick="testProxy()">üß™ Test Proxy</button>
                    <button class="btn" onclick="showProxyConfigs()">üîó Show Configs</button>
                </div>
                
                <div class="last-update" id="test-result"></div>
            </div>

            <!-- Security Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üõ°Ô∏è</div>
                    <div class="card-title">Security Status</div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Fail2Ban:</span>
                    <span class="status-value" id="fail2ban-status">Checking...</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Blocked IPs:</span>
                    <span class="status-value" id="blocked-ips">0</span>
                </div>
                
                <div class="actions">
                    <button class="btn" onclick="checkSecurity()">üîç Check Security</button>
                    <button class="btn btn-warning" onclick="showBlockedIPs()">üö´ View Blocked</button>
                </div>
            </div>

            <!-- System Management Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <div class="card-title">System Management</div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">File Permissions:</span>
                    <span class="status-value" id="permission-status">Checking...</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Recent Uploads:</span>
                    <span class="status-value" id="upload-status">None</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Auto-Fix:</span>
                    <span class="status-value" id="autofix-status">Enabled</span>
                </div>
                
                <div class="actions">
                    <button class="btn" onclick="checkPermissions()">üîç Check Permissions</button>
                    <button class="btn btn-warning" onclick="fixPermissions()">üîß Fix Permissions</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üîß Proxy Farm System v1.0 - Phase 1 | Made with ‚ù§Ô∏è for proxy management</p>
        </div>
    </div>

    <script>
        // Auto refresh every 10 seconds
        let autoRefreshInterval;
        
        // Start auto refresh
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(refreshStatus, 10000);
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            checkPermissions();
            checkUploadStatus();
            startAutoRefresh();
        });
        
        // Refresh all status
        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateDCOMStatus(data.dcom);
                updateProxyStatus(data.proxy);
                updateAPNInfo(data.apn);
                updateSystemInfo(data.system);
                
            } catch (error) {
                console.error('Error refreshing status:', error);
                showAlert('L·ªói khi refresh d·ªØ li·ªáu: ' + error.message, 'danger');
            }
        }
        
        function updateDCOMStatus(dcom) {
            const statusElement = document.getElementById('dcom-status');
            const signalElement = document.getElementById('dcom-signal');
            const ipElement = document.getElementById('dcom-ip');
            const networkElement = document.getElementById('dcom-network');
            const lastUpdateElement = document.getElementById('dcom-last-update');
            const signalBar = document.getElementById('signal-bar');
            
            // Update status with color
            statusElement.textContent = dcom.status;
            statusElement.className = 'status-value ' + (dcom.connected ? 'status-connected' : 'status-disconnected');
            
            // Update signal
            signalElement.textContent = dcom.signal;
            
            // Update signal bar
            if (dcom.signal !== 'N/A') {
                const signalValue = parseInt(dcom.signal.replace('dBm', ''));
                const signalPercent = Math.max(0, Math.min(100, (signalValue + 100) * 2)); // Convert dBm to percentage
                signalBar.style.width = signalPercent + '%';
            } else {
                signalBar.style.width = '0%';
            }
            
            // Update other fields
            ipElement.textContent = dcom.ip;
            networkElement.textContent = dcom.network;
            lastUpdateElement.textContent = 'Last update: ' + dcom.last_update;
        }
        
        function updateProxyStatus(proxy) {
            const statusElement = document.getElementById('proxy-status');
            const pidElement = document.getElementById('proxy-pid');
            const lastUpdateElement = document.getElementById('proxy-last-update');
            
            statusElement.textContent = proxy.status;
            statusElement.className = 'status-value ' + (proxy.running ? 'status-connected' : 'status-disconnected');
            
            pidElement.textContent = proxy.pid;
            lastUpdateElement.textContent = 'Last update: ' + proxy.last_update;
        }
        
        function updateAPNInfo(apn) {
            document.getElementById('apn-name').textContent = apn.name || 'Unknown';
            document.getElementById('apn-value').textContent = apn.apn || 'Unknown';
            document.getElementById('apn-username').textContent = apn.username || '(none)';
        }
        
        function updateSystemInfo(system) {
            const uptimeEl = document.getElementById('system-uptime');
            const timestampEl = document.getElementById('system-timestamp');
            
            if (uptimeEl) uptimeEl.textContent = system.uptime || 'Unknown';
            if (timestampEl) timestampEl.textContent = new Date(system.timestamp).toLocaleTimeString();
        }
        
        // Enhanced status update with user count
        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateDCOMStatus(data.dcom);
                updateProxyStatus(data.proxy);
                updateAPNInfo(data.apn);
                updateSystemInfo(data.system);
                
                // Update user count and stats
                if (data.proxy && data.proxy.total_users) {
                    const userCountEl = document.getElementById('user-count');
                    if (userCountEl) userCountEl.textContent = data.proxy.total_users;
                }
                
                if (data.proxy && data.proxy.active_connections) {
                    const activeConnEl = document.getElementById('active-connections');
                    if (activeConnEl) activeConnEl.textContent = data.proxy.active_connections;
                }
                
                // Update enhanced stats
                updateEnhancedStats();
                
            } catch (error) {
                console.error('Error refreshing status:', error);
                showAlert('L·ªói khi refresh d·ªØ li·ªáu: ' + error.message, 'danger');
            }
        }
        
        // User Management Functions
        async function generateRandomUser() {
            try {
                showAlert('üé≤ Generating random user...', 'info');
                
                const response = await fetch('/api/proxy/generate-random-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port_type: 'http' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const config = result.config;
                    showAlert(`
                        ‚úÖ Random user created successfully!<br>
                        <strong>Server:</strong> ${config.server_ip}<br>
                        <strong>Port:</strong> ${config.port}<br>
                        <strong>Username:</strong> ${config.username}<br>
                        <strong>Password:</strong> ${config.password}<br>
                        <strong>Proxy String:</strong> ${config.proxy_string}<br>
                        <strong>Test Command:</strong><br>
                        <code style="font-size: 12px;">${config.curl_example[0]}</code>
                    `, 'success');
                    
                    refreshStatus();
                } else {
                    showAlert('‚ùå Failed to create random user: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Error generating random user: ' + error.message, 'danger');
            }
        }
        
        async function showAddUserModal() {
            const username = prompt('Enter username:');
            const password = prompt('Enter password:');
            
            if (username && password) {
                try {
                    showAlert('‚ûï Adding user...', 'info');
                    
                    const response = await fetch('/api/proxy/users/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showAlert('‚úÖ User added successfully!', 'success');
                        refreshStatus();
                    } else {
                        showAlert('‚ùå Failed to add user: ' + result.message, 'danger');
                    }
                } catch (error) {
                    showAlert('‚ùå Error adding user: ' + error.message, 'danger');
                }
            }
        }
        
        async function showUsersTable() {
            try {
                const response = await fetch('/api/proxy/users');
                const result = await response.json();
                
                if (result.success) {
                    let usersHTML = '<h3>üë• All Users:</h3>';
                    usersHTML += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    usersHTML += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd;">Username</th><th style="padding: 8px; border: 1px solid #ddd;">Type</th><th style="padding: 8px; border: 1px solid #ddd;">Actions</th></tr>';
                    
                    result.users.forEach(user => {
                        usersHTML += `<tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${user.username}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${user.type}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                <button onclick="generateProxyConfig('${user.username}')" style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 3px; margin: 2px;">Config</button>
                                <button onclick="removeUser('${user.username}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; margin: 2px;">Delete</button>
                            </td>
                        </tr>`;
                    });
                    
                    usersHTML += '</table>';
                    showAlert(usersHTML, 'info');
                } else {
                    showAlert('‚ùå Failed to load users: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Error loading users: ' + error.message, 'danger');
            }
        }
        
        async function generateProxyConfig(username) {
            try {
                const response = await fetch('/api/proxy/generate-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, port_type: 'http' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const config = result.config;
                    showAlert(`
                        üîó Proxy Configuration for ${username}:<br>
                        <strong>Server:</strong> ${config.server_ip}<br>
                        <strong>Port:</strong> ${config.port}<br>
                        <strong>Proxy String:</strong> ${config.proxy_string}<br>
                        <strong>Test Commands:</strong><br>
                        ${config.curl_example.map(cmd => `<code style="font-size: 11px; display: block; margin: 2px 0;">${cmd}</code>`).join('')}
                    `, 'info');
                } else {
                    showAlert('‚ùå Failed to generate config: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Error generating config: ' + error.message, 'danger');
            }
        }
        
        async function removeUser(username) {
            if (confirm(`Are you sure you want to delete user: ${username}?`)) {
                try {
                    const response = await fetch('/api/proxy/users/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showAlert('‚úÖ User removed successfully!', 'success');
                        refreshStatus();
                    } else {
                        showAlert('‚ùå Failed to remove user: ' + result.message, 'danger');
                    }
                } catch (error) {
                    showAlert('‚ùå Error removing user: ' + error.message, 'danger');
                }
            }
        }
        
        // Proxy Testing Functions
        async function testProxy() {
            const port = document.getElementById('test-port').value;
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            
            try {
                showAlert('üß™ Testing proxy connection...', 'info');
                
                const response = await fetch('/api/proxy/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port, username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('test-result').innerHTML = `
                        ‚úÖ Test successful!<br>
                        Public IP: ${result.ip}<br>
                        Response: ${result.response_time}
                    `;
                    showAlert('‚úÖ Proxy test successful! IP: ' + result.ip, 'success');
                } else {
                    document.getElementById('test-result').innerHTML = `‚ùå Test failed: ${result.message}`;
                    showAlert('‚ùå Proxy test failed: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Error testing proxy: ' + error.message, 'danger');
            }
        }
        
        async function updateEnhancedStats() {
            try {
                const response = await fetch('/api/users/stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    
                    // Update online users
                    const onlineUsersEl = document.getElementById('online-users');
                    if (onlineUsersEl) onlineUsersEl.textContent = stats.online_users;
                    
                    // Update active connections if not already set
                    const activeConnEl = document.getElementById('active-connections');
                    if (activeConnEl && activeConnEl.textContent === '0') {
                        activeConnEl.textContent = stats.active_connections;
                    }
                }
            } catch (error) {
                console.error('Error updating enhanced stats:', error);
            }
        }
        
        // Security Functions
        async function checkSecurity() {
            try {
                const response = await fetch('/api/fail2ban/status');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('fail2ban-status').textContent = result.status;
                    document.getElementById('fail2ban-status').className = 'status-value status-connected';
                    
                    // Check 3proxy jail
                    const jailResponse = await fetch('/api/fail2ban/3proxy');
                    const jailResult = await jailResponse.json();
                    
                    if (jailResult.success) {
                        showAlert('üõ°Ô∏è Security Status OK - Fail2ban is protecting your proxies!', 'success');
                    }
                } else {
                    document.getElementById('fail2ban-status').textContent = 'Error';
                    document.getElementById('fail2ban-status').className = 'status-value status-disconnected';
                    showAlert('‚ö†Ô∏è Fail2ban not running - Install fail2ban for security!', 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Error checking security: ' + error.message, 'danger');
            }
        }
        
        // DCOM Actions
        async function restartDCOM() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën restart k·∫øt n·ªëi DCOM? ƒêi·ªÅu n√†y s·∫Ω ƒë·ªïi IP v√† m·∫•t k·∫øt n·ªëi t·∫°m th·ªùi.')) {
                return;
            }
            
            try {
                showAlert('ƒêang restart DCOM connection...', 'info');
                const response = await fetch('/api/dcom/restart', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ DCOM connection ƒë√£ ƒë∆∞·ª£c restart th√†nh c√¥ng!', 'success');
                    setTimeout(refreshStatus, 5000); // Refresh after 5 seconds
                } else {
                    showAlert('‚ùå L·ªói khi restart DCOM: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi restart DCOM: ' + error.message, 'danger');
            }
        }
        
        // Proxy Actions
        async function startProxy() {
            try {
                showAlert('ƒêang start 3proxy...', 'info');
                const response = await fetch('/api/proxy/start', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ 3proxy ƒë√£ ƒë∆∞·ª£c start th√†nh c√¥ng!', 'success');
                    setTimeout(refreshStatus, 2000);
                } else {
                    showAlert('‚ùå L·ªói khi start 3proxy: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi start 3proxy: ' + error.message, 'danger');
            }
        }
        
        async function stopProxy() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën stop 3proxy?')) {
                return;
            }
            
            try {
                showAlert('ƒêang stop 3proxy...', 'info');
                const response = await fetch('/api/proxy/stop', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ 3proxy ƒë√£ ƒë∆∞·ª£c stop!', 'success');
                    setTimeout(refreshStatus, 2000);
                } else {
                    showAlert('‚ùå L·ªói khi stop 3proxy: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi stop 3proxy: ' + error.message, 'danger');
            }
        }
        
        // APN Functions
        async function showAPNProfiles() {
            try {
                const response = await fetch('/api/apn/list');
                const data = await response.json();
                
                if (data.profiles && data.profiles.length > 0) {
                    let profilesHTML = '<h3>üìã Available APN Profiles:</h3><ul>';
                    data.profiles.forEach(profile => {
                        profilesHTML += `<li><strong>${profile.name}</strong>: ${profile.apn} - ${profile.description}</li>`;
                    });
                    profilesHTML += '</ul>';
                    
                    showAlert(profilesHTML, 'info');
                } else {
                    showAlert('‚ùå Kh√¥ng t√¨m th·∫•y APN profiles', 'danger');
                }
            } catch (error) {
                showAlert('‚ùå L·ªói khi load APN profiles: ' + error.message, 'danger');
            }
        }
        
        function openAPNManager() {
            showAlert('üí° ƒê·ªÉ qu·∫£n l√Ω APN, h√£y s·ª≠ d·ª•ng terminal v·ªõi l·ªánh: ./apn-manager.sh list', 'info');
        }
        
        function viewLogs() {
            showAlert('üí° Logs ƒë∆∞·ª£c l∆∞u t·∫°i: /home/proxy-farm-system/logs/', 'info');
        }

        // Permission Management Functions
        async function checkPermissions() {
            try {
                const response = await fetch('/api/system/permissions/check');
                const result = await response.json();
                
                const statusEl = document.getElementById('permission-status');
                if (result.success) {
                    if (result.status === 'good') {
                        statusEl.textContent = 'Good';
                        statusEl.className = 'status-value status-connected';
                    } else {
                        statusEl.textContent = `${result.total_issues} issues`;
                        statusEl.className = 'status-value status-disconnected';
                        
                        if (result.total_issues > 0) {
                            showAlert(`‚ö†Ô∏è Found ${result.total_issues} permission issues. Click "Fix Permissions" to resolve.`, 'warning');
                        }
                    }
                } else {
                    statusEl.textContent = 'Error';
                    statusEl.className = 'status-value status-disconnected';
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
                document.getElementById('permission-status').textContent = 'Error';
            }
        }

        async function checkUploadStatus() {
            try {
                const response = await fetch('/api/system/upload-status');
                const result = await response.json();
                
                const uploadEl = document.getElementById('upload-status');
                if (result.success && result.upload_detected) {
                    uploadEl.textContent = `${result.recent_uploads.length} recent`;
                    uploadEl.className = 'status-value status-unknown';
                    
                    showAlert('üìÅ Recent file uploads detected. Consider running permission fix.', 'info');
                } else {
                    uploadEl.textContent = 'None';
                    uploadEl.className = 'status-value status-connected';
                }
            } catch (error) {
                console.error('Error checking upload status:', error);
            }
        }

        async function fixPermissions() {
            if (!confirm('Fix file permissions? This will make scripts executable and secure config files.')) {
                return;
            }
            
            try {
                showAlert('üîß Fixing file permissions...', 'info');
                
                const response = await fetch('/api/system/permissions/fix', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Permissions fixed successfully!', 'success');
                    
                    // Show what was fixed
                    if (result.fixes_applied) {
                        let fixesText = 'Fixed:\n' + result.fixes_applied.map(fix => `‚Ä¢ ${fix}`).join('\n');
                        setTimeout(() => {
                            showAlert(fixesText, 'info');
                        }, 2000);
                    }
                    
                    // Refresh permission status
                    setTimeout(() => {
                        checkPermissions();
                        checkUploadStatus();
                    }, 3000);
                } else {
                    showAlert('‚ùå Permission fix failed: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Error fixing permissions: ' + error.message, 'danger');
            }
        }
        
        // Alert system
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            alertsContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshStatus();
                        break;
                    case 'd':
                        e.preventDefault();
                        restartDCOM();
                        break;
                }
            }
        });
        
        // Page visibility API - pause refresh when tab is not visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(autoRefreshInterval);
            } else {
                startAutoRefresh();
                refreshStatus(); // Refresh immediately when coming back
            }
        });
    </script>
</body>
</html>
